{% extends "base.html" %}

{% block title %}ç½‘ç»œåˆ†ææŠ¥å‘Š - {{ session_info.name }}{% endblock %}

{% block extra_css %}
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #007acc;
    }
    
    .metric-card .icon {
        font-size: 2em;
        margin-bottom: 10px;
    }
    
    .metric-card .value {
        font-size: 1.8em;
        font-weight: bold;
        color: #007acc;
    }
    
    .metric-card .name {
        color: #666;
        margin-top: 5px;
    }
    
    .chart-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    .chart-section h3 {
        color: #007acc;
        margin-bottom: 15px;
        border-bottom: 2px solid #007acc;
        padding-bottom: 5px;
    }
    
    .info-box {
        background: #e8f4fd;
        border: 1px solid #b3d9ff;
        border-radius: 5px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .info-box h4 {
        color: #007acc;
        margin-top: 0;
    }
    
    .highlight {
        background: linear-gradient(120deg, #a8e6cf 0%, #dcedc1 100%);
        padding: 2px 6px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<!-- å…³é”®æŒ‡æ ‡ä»ªè¡¨æ¿ -->
<div class="section">
    <h2>ğŸ“Š å…³é”®æŒ‡æ ‡</h2>
    <div class="metrics-grid">
        {% for metric in summary_stats.key_metrics %}
        <div class="metric-card">
            <div class="icon">{{ metric.icon }}</div>
            <div class="value">{{ metric.value }}</div>
            <div class="name">{{ metric.name }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ä¼šè¯ä¿¡æ¯ -->
<div class="section">
    <h2>â„¹ï¸ ä¼šè¯ä¿¡æ¯</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>é¡¹ç›®</th>
                    <th>å€¼</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>ä¼šè¯ID</td><td>{{ session_info.session_id }}</td></tr>
                <tr><td>ä¼šè¯åç§°</td><td>{{ session_info.name }}</td></tr>
                <tr><td>åˆ›å»ºæ—¶é—´</td><td>{{ session_info.created_time | format_datetime }}</td></tr>
                <tr><td>æ•°æ®åŒ…æ•°é‡</td><td class="highlight">{{ "{:,}".format(session_info.packet_count) }}</td></tr>
                <tr><td>æŒç»­æ—¶é—´</td><td>{{ session_info.duration | format_duration }}</td></tr>
                {% if session_info.file_path %}
                <tr><td>æ–‡ä»¶è·¯å¾„</td><td>{{ session_info.file_path }}</td></tr>
                {% endif %}
                {% if session_info.description %}
                <tr><td>æè¿°</td><td>{{ session_info.description }}</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- åè®®ç»Ÿè®¡åˆ†æ -->
<div class="section">
    <h2>ğŸ”— åè®®ç»Ÿè®¡åˆ†æ</h2>
    
    <!-- åè®®åˆ†å¸ƒå›¾è¡¨ -->
    {% if charts.protocol_pie_chart %}
    <div class="chart-section">
        <h3>åè®®åˆ†å¸ƒå›¾</h3>
        <div class="chart-container">
            <img src="{{ charts.protocol_pie_chart }}" alt="åè®®åˆ†å¸ƒå›¾" style="max-width: 100%; height: auto;">
        </div>
    </div>
    {% endif %}
    
    <!-- åè®®ç»Ÿè®¡è¡¨æ ¼ -->
    {% if protocol_stats.table_data %}
    <div class="chart-section">
        <h3>è¯¦ç»†åè®®ç»Ÿè®¡</h3>
        <div class="table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>åè®®ç±»å‹</th>
                        <th>æ•°æ®åŒ…æ•°é‡</th>
                        <th>å­—èŠ‚æ•°</th>
                        <th>åŒ…å æ¯”</th>
                        <th>å­—èŠ‚å æ¯”</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in protocol_stats.table_data[:15] %}
                    <tr>
                        <td><strong>{{ row.protocol }}</strong></td>
                        <td>{{ "{:,}".format(row.packet_count) }}</td>
                        <td>{{ row.byte_count | format_bytes }}</td>
                        <td>{{ row.percentage | format_percentage }}</td>
                        <td>{{ ((row.byte_count / (summary_stats.advanced_stats.total_bytes or 1)) * 100) | format_percentage }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Topåè®®å›¾è¡¨ -->
    {% if charts.top_protocols_chart %}
    <div class="chart-section">
        <h3>Topåè®®ç»Ÿè®¡</h3>
        <div class="chart-container">
            <img src="{{ charts.top_protocols_chart }}" alt="Topåè®®ç»Ÿè®¡å›¾">
        </div>
    </div>
    {% endif %}
</div>

<!-- æµé‡è¶‹åŠ¿åˆ†æ -->
<div class="section">
    <h2>ğŸ“ˆ æµé‡è¶‹åŠ¿åˆ†æ</h2>
    
    <!-- æµé‡è¶‹åŠ¿å›¾è¡¨ -->
    {% if charts.traffic_trend_chart %}
    <div class="chart-section">
        <h3>æµé‡è¶‹åŠ¿å›¾</h3>
        <div class="chart-container">
            <img src="{{ charts.traffic_trend_chart }}" alt="æµé‡è¶‹åŠ¿å›¾">
        </div>
    </div>
    {% endif %}
    
    <!-- æµé‡å³°å€¼ä¿¡æ¯ -->
    {% if traffic_trends.peak_info %}
    <div class="info-box">
        <h4>ğŸ”¥ æµé‡å³°å€¼ä¿¡æ¯</h4>
        <p><strong>å³°å€¼æµé‡:</strong> <span class="highlight">{{ traffic_trends.peak_info.max_packets }} ä¸ªæ•°æ®åŒ…</span></p>
        <p><strong>å³°å€¼æ—¶é—´:</strong> {{ traffic_trends.peak_info.peak_time }}</p>
        <p><strong>å¹³å‡æµé‡:</strong> {{ "%.1f"|format(traffic_trends.peak_info.avg_packets) }} ä¸ªæ•°æ®åŒ…/ç§’</p>
    </div>
    {% endif %}
    
    <!-- æ—¶é—´åºåˆ—æ•°æ®é¢„è§ˆ -->
    {% if traffic_trends.time_series %}
    <div class="chart-section">
        <h3>æ—¶é—´åºåˆ—æ•°æ® (å‰20æ¡)</h3>
        <div class="table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æ•°æ®åŒ…æ•°</th>
                        <th>å­—èŠ‚æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in traffic_trends.time_series[:20] %}
                    <tr>
                        <td>{{ item.time }}</td>
                        <td>{{ item.packets }}</td>
                        <td>{{ item.bytes | format_bytes }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if traffic_trends.time_series|length > 20 %}
        <p style="text-align: center; color: #666; font-style: italic;">
            æ˜¾ç¤ºå‰20æ¡ï¼Œå…±{{ traffic_trends.time_series|length }}æ¡è®°å½•
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- ç»¼åˆä»ªè¡¨æ¿ -->
{% if charts.dashboard_chart %}
<div class="section">
    <h2>ğŸ“‹ ç»¼åˆä»ªè¡¨æ¿</h2>
    <div class="chart-section">
        <div class="chart-container">
            <img src="{{ charts.dashboard_chart }}" alt="ç»¼åˆä»ªè¡¨æ¿" style="width: 100%; max-width: 1000px;">
        </div>
    </div>
</div>
{% endif %}

<!-- åˆ†æç»“è®º -->
<div class="section">
    <h2>ğŸ“ åˆ†æç»“è®º</h2>
    <div class="info-box">
        <h4>ç½‘ç»œæµé‡ç‰¹å¾åˆ†æ</h4>
        <p>åŸºäºå¯¹ <strong>{{ "{:,}".format(session_info.packet_count) }}</strong> ä¸ªæ•°æ®åŒ…çš„åˆ†æï¼Œè¯¥ç½‘ç»œä¼šè¯å‘ˆç°ä»¥ä¸‹ç‰¹å¾ï¼š</p>
        
        <ul style="margin: 15px 0; padding-left: 20px;">
            <li><strong>åè®®å¤šæ ·æ€§:</strong> æ£€æµ‹åˆ° {{ summary_stats.advanced_stats.protocol_diversity }} ç§ä¸åŒåè®®</li>
            <li><strong>æµé‡å¼ºåº¦:</strong> å¹³å‡é€Ÿç‡ä¸º {{ "%.1f"|format(summary_stats.advanced_stats.avg_packet_rate) }} åŒ…/ç§’</li>
            <li><strong>ç½‘ç»œè§„æ¨¡:</strong> æ¶‰åŠ {{ summary_stats.advanced_stats.unique_src_ips }} ä¸ªæºIPå’Œ {{ summary_stats.advanced_stats.unique_dst_ips }} ä¸ªç›®æ ‡IP</li>
            <li><strong>æ•°æ®ç‰¹å¾:</strong> å¹³å‡åŒ…å¤§å°ä¸º {{ "%.1f"|format(summary_stats.advanced_stats.avg_packet_size) }} å­—èŠ‚</li>
        </ul>
        
        {% set dominant_protocol = protocol_stats.table_data[0] if protocol_stats.table_data else None %}
        {% if dominant_protocol %}
        <p>
            <strong>ä¸»è¦åè®®:</strong> {{ dominant_protocol.protocol }} å æ®äº† 
            <span class="highlight">{{ dominant_protocol.percentage | format_percentage }}</span> çš„æµé‡ï¼Œ
            è¡¨æ˜ç½‘ç»œé€šä¿¡ä»¥è¯¥åè®®ä¸ºä¸»ã€‚
        </p>
        {% endif %}
        
        <p style="margin-top: 15px; font-style: italic; color: #666;">
            è¯¥åˆ†ææŠ¥å‘Šç”±è½»é‡çº§æ•°æ®åŒ…åˆ†æå™¨è‡ªåŠ¨ç”Ÿæˆï¼Œæ•°æ®å‡†ç¡®æ€§ä¾èµ–äºåŸå§‹æ•è·æ•°æ®çš„å®Œæ•´æ€§ã€‚
        </p>
    </div>
</div>

<!-- æŠ€æœ¯ä¿¡æ¯ -->
<div class="section" style="background: #f8f9fa; border: 1px solid #dee2e6;">
    <h2>ğŸ”§ æŠ€æœ¯ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <strong>åˆ†ææ—¶é—´è·¨åº¦:</strong><br>
            {{ summary_stats.advanced_stats.time_span | format_duration }}
        </div>
        <div>
            <strong>æ•°æ®æ€»é‡:</strong><br>
            {{ summary_stats.advanced_stats.total_bytes | format_bytes }}
        </div>
        <div>
            <strong>æŠ¥å‘Šç”Ÿæˆæ—¶é—´:</strong><br>
            {{ generation_time | format_datetime }}
        </div>
        <div>
            <strong>åˆ†æå™¨ç‰ˆæœ¬:</strong><br>
            v1.0.0
        </div>
    </div>
</div>
{% endblock %}