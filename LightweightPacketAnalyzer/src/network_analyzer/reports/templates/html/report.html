{% extends "base.html" %}

{% block title %}网络分析报告 - {{ session_info.name }}{% endblock %}

{% block extra_css %}
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #007acc;
    }
    
    .metric-card .icon {
        font-size: 2em;
        margin-bottom: 10px;
    }
    
    .metric-card .value {
        font-size: 1.8em;
        font-weight: bold;
        color: #007acc;
    }
    
    .metric-card .name {
        color: #666;
        margin-top: 5px;
    }
    
    .chart-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    .chart-section h3 {
        color: #007acc;
        margin-bottom: 15px;
        border-bottom: 2px solid #007acc;
        padding-bottom: 5px;
    }
    
    .info-box {
        background: #e8f4fd;
        border: 1px solid #b3d9ff;
        border-radius: 5px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .info-box h4 {
        color: #007acc;
        margin-top: 0;
    }
    
    .highlight {
        background: linear-gradient(120deg, #a8e6cf 0%, #dcedc1 100%);
        padding: 2px 6px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<!-- 关键指标仪表板 -->
<div class="section">
    <h2>📊 关键指标</h2>
    <div class="metrics-grid">
        {% for metric in summary_stats.key_metrics %}
        <div class="metric-card">
            <div class="icon">{{ metric.icon }}</div>
            <div class="value">{{ metric.value }}</div>
            <div class="name">{{ metric.name }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- 会话信息 -->
<div class="section">
    <h2>ℹ️ 会话信息</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>项目</th>
                    <th>值</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>会话ID</td><td>{{ session_info.session_id }}</td></tr>
                <tr><td>会话名称</td><td>{{ session_info.name }}</td></tr>
                <tr><td>创建时间</td><td>{{ session_info.created_time | format_datetime }}</td></tr>
                <tr><td>数据包数量</td><td class="highlight">{{ "{:,}".format(session_info.packet_count) }}</td></tr>
                <tr><td>持续时间</td><td>{{ session_info.duration | format_duration }}</td></tr>
                {% if session_info.file_path %}
                <tr><td>文件路径</td><td>{{ session_info.file_path }}</td></tr>
                {% endif %}
                {% if session_info.description %}
                <tr><td>描述</td><td>{{ session_info.description }}</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 协议统计分析 -->
<div class="section">
    <h2>🔗 协议统计分析</h2>
    
    <!-- 协议分布图表 -->
    {% if charts.protocol_pie_chart %}
    <div class="chart-section">
        <h3>协议分布图</h3>
        <div class="chart-container">
            <img src="{{ charts.protocol_pie_chart }}" alt="协议分布图" style="max-width: 100%; height: auto;">
        </div>
    </div>
    {% endif %}
    
    <!-- 协议统计表格 -->
    {% if protocol_stats.table_data %}
    <div class="chart-section">
        <h3>详细协议统计</h3>
        <div class="table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>协议类型</th>
                        <th>数据包数量</th>
                        <th>字节数</th>
                        <th>包占比</th>
                        <th>字节占比</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in protocol_stats.table_data[:15] %}
                    <tr>
                        <td><strong>{{ row.protocol }}</strong></td>
                        <td>{{ "{:,}".format(row.packet_count) }}</td>
                        <td>{{ row.byte_count | format_bytes }}</td>
                        <td>{{ row.percentage | format_percentage }}</td>
                        <td>{{ ((row.byte_count / (summary_stats.advanced_stats.total_bytes or 1)) * 100) | format_percentage }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Top协议图表 -->
    {% if charts.top_protocols_chart %}
    <div class="chart-section">
        <h3>Top协议统计</h3>
        <div class="chart-container">
            <img src="{{ charts.top_protocols_chart }}" alt="Top协议统计图">
        </div>
    </div>
    {% endif %}
</div>

<!-- 流量趋势分析 -->
<div class="section">
    <h2>📈 流量趋势分析</h2>
    
    <!-- 流量趋势图表 -->
    {% if charts.traffic_trend_chart %}
    <div class="chart-section">
        <h3>流量趋势图</h3>
        <div class="chart-container">
            <img src="{{ charts.traffic_trend_chart }}" alt="流量趋势图">
        </div>
    </div>
    {% endif %}
    
    <!-- 流量峰值信息 -->
    {% if traffic_trends.peak_info %}
    <div class="info-box">
        <h4>🔥 流量峰值信息</h4>
        <p><strong>峰值流量:</strong> <span class="highlight">{{ traffic_trends.peak_info.max_packets }} 个数据包</span></p>
        <p><strong>峰值时间:</strong> {{ traffic_trends.peak_info.peak_time }}</p>
        <p><strong>平均流量:</strong> {{ "%.1f"|format(traffic_trends.peak_info.avg_packets) }} 个数据包/秒</p>
    </div>
    {% endif %}
    
    <!-- 时间序列数据预览 -->
    {% if traffic_trends.time_series %}
    <div class="chart-section">
        <h3>时间序列数据 (前20条)</h3>
        <div class="table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>数据包数</th>
                        <th>字节数</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in traffic_trends.time_series[:20] %}
                    <tr>
                        <td>{{ item.time }}</td>
                        <td>{{ item.packets }}</td>
                        <td>{{ item.bytes | format_bytes }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if traffic_trends.time_series|length > 20 %}
        <p style="text-align: center; color: #666; font-style: italic;">
            显示前20条，共{{ traffic_trends.time_series|length }}条记录
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 综合仪表板 -->
{% if charts.dashboard_chart %}
<div class="section">
    <h2>📋 综合仪表板</h2>
    <div class="chart-section">
        <div class="chart-container">
            <img src="{{ charts.dashboard_chart }}" alt="综合仪表板" style="width: 100%; max-width: 1000px;">
        </div>
    </div>
</div>
{% endif %}

<!-- 分析结论 -->
<div class="section">
    <h2>📝 分析结论</h2>
    <div class="info-box">
        <h4>网络流量特征分析</h4>
        <p>基于对 <strong>{{ "{:,}".format(session_info.packet_count) }}</strong> 个数据包的分析，该网络会话呈现以下特征：</p>
        
        <ul style="margin: 15px 0; padding-left: 20px;">
            <li><strong>协议多样性:</strong> 检测到 {{ summary_stats.advanced_stats.protocol_diversity }} 种不同协议</li>
            <li><strong>流量强度:</strong> 平均速率为 {{ "%.1f"|format(summary_stats.advanced_stats.avg_packet_rate) }} 包/秒</li>
            <li><strong>网络规模:</strong> 涉及 {{ summary_stats.advanced_stats.unique_src_ips }} 个源IP和 {{ summary_stats.advanced_stats.unique_dst_ips }} 个目标IP</li>
            <li><strong>数据特征:</strong> 平均包大小为 {{ "%.1f"|format(summary_stats.advanced_stats.avg_packet_size) }} 字节</li>
        </ul>
        
        {% set dominant_protocol = protocol_stats.table_data[0] if protocol_stats.table_data else None %}
        {% if dominant_protocol %}
        <p>
            <strong>主要协议:</strong> {{ dominant_protocol.protocol }} 占据了 
            <span class="highlight">{{ dominant_protocol.percentage | format_percentage }}</span> 的流量，
            表明网络通信以该协议为主。
        </p>
        {% endif %}
        
        <p style="margin-top: 15px; font-style: italic; color: #666;">
            该分析报告由轻量级数据包分析器自动生成，数据准确性依赖于原始捕获数据的完整性。
        </p>
    </div>
</div>

<!-- 技术信息 -->
<div class="section" style="background: #f8f9fa; border: 1px solid #dee2e6;">
    <h2>🔧 技术信息</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <strong>分析时间跨度:</strong><br>
            {{ summary_stats.advanced_stats.time_span | format_duration }}
        </div>
        <div>
            <strong>数据总量:</strong><br>
            {{ summary_stats.advanced_stats.total_bytes | format_bytes }}
        </div>
        <div>
            <strong>报告生成时间:</strong><br>
            {{ generation_time | format_datetime }}
        </div>
        <div>
            <strong>分析器版本:</strong><br>
            v1.0.0
        </div>
    </div>
</div>
{% endblock %}