# 捕获选项功能 - 需求对齐文档

## 项目上下文分析

### 现有项目架构
- **项目名称**: 轻量级网络数据包分析工具 (LightweightPacketAnalyzer)
- **技术栈**: Python + Tkinter + Scapy + SQLite
- **架构模式**: MVC模式，分层架构
- **核心模块**:
  - GUI层: `src/network_analyzer/gui/main_window.py`
  - 捕获层: `src/network_analyzer/capture/packet_capture.py`
  - 配置层: `src/network_analyzer/config/settings.py`
  - 存储层: `src/network_analyzer/storage/data_manager.py`

### 现有捕获功能状态
- **PacketCapture类** 已实现基础捕获功能:
  - 获取可用网络接口 (`get_available_interfaces()`)
  - 支持接口选择和过滤表达式
  - 支持捕获超时设置
  - 基本统计信息收集
- **Settings类** 已定义相关配置项:
  - `CAPTURE_INTERFACE`: 捕获接口
  - `CAPTURE_FILTER`: 捕获过滤器
  - `CAPTURE_TIMEOUT`: 捕获超时
  - `MAX_PACKET_COUNT`: 最大数据包数量
  - `ENABLE_PROMISCUOUS_MODE`: 混杂模式
  - `BUFFER_SIZE`: 缓冲区大小

### GUI设计模式
- 使用 `tk.Toplevel` 创建模态对话框
- 遵循 `SessionDialog` 的设计模式:
  - 居中显示
  - 使用 `grab_set()` 实现模态
  - ttk组件创建现代化UI
  - 确定/取消按钮布局

## 原始需求分析

### 用户需求
用户在主窗口的"捕获"菜单中点击"捕获选项"时，期望打开一个配置对话框，能够：
1. 选择网络接口
2. 设置数据包过滤条件
3. 配置捕获参数
4. 设置高级选项

### 当前状态
- `_capture_options()` 函数仅显示占位符消息："将在后续版本中实现"
- 底层捕获功能已完备，但缺少GUI配置界面
- 配置系统已就绪，但无法通过GUI修改

## 功能边界确认

### 包含功能
1. **网络接口选择**
   - 显示所有可用网络接口
   - 支持自动选择和手动选择
   - 显示接口基本信息

2. **过滤器配置**
   - BPF过滤表达式输入
   - 常用过滤器模板（HTTP、TCP、UDP等）
   - 过滤器语法验证

3. **捕获参数设置**
   - 最大数据包数量限制
   - 捕获时间限制
   - 文件大小限制（如适用）

4. **高级选项**
   - 混杂模式开关
   - 缓冲区大小设置
   - 捕获超时设置

5. **设置持久化**
   - 保存用户配置到Settings
   - 下次打开时恢复上次设置

### 不包含功能
- 实时捕获预览
- 复杂的过滤器构建器
- 网络接口详细配置
- 捕获文件格式选择

## 需求理解确认

### 技术实现理解
1. **对话框设计**: 创建 `CaptureOptionsDialog` 类，继承现有对话框设计模式
2. **数据绑定**: 与 `Settings` 类双向绑定，读取和保存配置
3. **接口集成**: 调用 `PacketCapture.get_available_interfaces()` 获取接口列表
4. **验证机制**: 实现BPF过滤器语法验证
5. **状态管理**: 确保配置更改立即生效

### 用户交互流程
1. 用户点击"捕获选项"菜单
2. 打开模态对话框
3. 显示当前配置
4. 用户修改设置
5. 点击"确定"保存，或"取消"放弃更改
6. 配置立即应用到捕获系统

## 疑问澄清

### 已解决的设计决策
1. **界面风格**: 遵循现有ttk风格，与SessionDialog保持一致
2. **配置存储**: 使用现有Settings系统，无需额外存储
3. **验证策略**: 客户端验证为主，服务端验证为辅
4. **错误处理**: 使用messagebox显示错误信息

### 需要确认的关键决策点
1. **过滤器模板**: 是否需要预定义常用过滤器模板？
2. **实时验证**: 是否需要实时验证BPF过滤器语法？
3. **高级选项**: 混杂模式等高级选项是否需要警告提示？
4. **接口信息**: 是否需要显示接口的详细信息（IP地址、状态等）？

## 验收标准

### 功能验收
- [ ] 能够显示所有可用网络接口
- [ ] 能够设置和验证BPF过滤表达式
- [ ] 能够配置捕获参数（数量、时间限制）
- [ ] 能够设置高级选项（混杂模式、缓冲区）
- [ ] 配置能够正确保存和加载
- [ ] 对话框UI符合项目设计规范

### 技术验收
- [ ] 与现有PacketCapture类无缝集成
- [ ] 与Settings配置系统正确交互
- [ ] 错误处理完善，用户体验良好
- [ ] 代码符合项目规范和风格
- [ ] 单元测试覆盖核心功能

### 用户体验验收
- [ ] 界面直观易用
- [ ] 响应速度快
- [ ] 错误提示清晰
- [ ] 配置持久化正常工作

## 技术约束

### 必须遵循的约束
- 使用Python + Tkinter技术栈
- 遵循现有项目架构和代码规范
- 与现有Settings和PacketCapture类集成
- 保持向后兼容性

### 性能约束
- 对话框打开时间 < 1秒
- 接口列表加载时间 < 2秒
- 配置保存时间 < 0.5秒

### 安全约束
- 混杂模式需要管理员权限时给出提示
- 过滤器表达式需要验证，防止注入
- 敏感配置不在日志中显示

## 集成方案

### 与现有系统集成
1. **GUI集成**: 替换 `main_window.py` 中的 `_capture_options()` 占位符
2. **配置集成**: 读写 `Settings` 类的相关属性
3. **捕获集成**: 配置更改后立即应用到 `PacketCapture` 实例
4. **测试集成**: 添加到现有测试套件中

### 文件结构
```
src/network_analyzer/gui/
├── main_window.py          # 修改_capture_options方法
├── capture_options_dialog.py  # 新增对话框类
└── __init__.py

docs/捕获选项功能/
├── ALIGNMENT_捕获选项功能.md    # 本文档
├── CONSENSUS_捕获选项功能.md    # 待创建
├── DESIGN_捕获选项功能.md       # 待创建
└── TASK_捕获选项功能.md         # 待创建
```

---

**文档状态**: 初始版本  
**创建时间**: 2024年  
**下一步**: 等待关键决策点确认，然后创建CONSENSUS文档