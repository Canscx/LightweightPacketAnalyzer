# 捕获选项功能 - 共识文档 (CONSENSUS)

## 项目信息
- **任务名称**: 捕获选项功能
- **创建时间**: 2025-01-27
- **状态**: 已确认
- **决策方案**: 选项A - 完整功能方案

## 最终共识

### 1. 明确的需求描述

**核心功能**:
- 网络接口选择（带详细信息显示）
- BPF过滤器配置（带模板和实时验证）
- 捕获参数设置（超时、包数量限制）
- 高级选项配置（混杂模式、管理员权限警告）
- 配置持久化保存

**用户交互流程**:
1. 用户点击"捕获选项"菜单项
2. 打开模态对话框
3. 配置各项参数
4. 实时验证和反馈
5. 保存配置并应用

### 2. 技术实现方案

**架构集成**:
- 基于现有 `PacketCapture` 类扩展
- 利用 `Settings` 类进行配置管理
- 遵循 `SessionDialog` 的GUI设计模式
- 使用 `tkinter/ttk` 组件库

**核心组件**:
- `CaptureOptionsDialog` 类（新增）
- 过滤器模板管理器
- BPF语法验证器
- 网络接口信息获取器

### 3. 功能特性确认

#### ✅ 包含功能
1. **过滤器模板**: 预定义常用BPF过滤器
   - HTTP流量: `tcp port 80`
   - HTTPS流量: `tcp port 443`
   - DNS查询: `udp port 53`
   - ICMP包: `icmp`
   - 特定主机: `host x.x.x.x`

2. **实时验证**: BPF表达式语法检查
   - 使用Scapy的compile_filter功能
   - 实时颜色反馈（绿色=正确，红色=错误）
   - 错误提示信息

3. **接口详细信息**: 显示网络接口完整信息
   - 接口名称和描述
   - IP地址和子网掩码
   - 接口状态（活跃/非活跃）
   - MAC地址

4. **高级选项警告**: 混杂模式权限提示
   - 警告图标和说明文字
   - 管理员权限要求提示

#### ❌ 排除功能
- 复杂的过滤器构建器
- 网络拓扑发现
- 实时流量监控
- 高级统计分析

### 4. 验收标准

#### 功能验收
- [ ] 能够选择可用的网络接口
- [ ] 能够输入和验证BPF过滤器
- [ ] 过滤器模板功能正常
- [ ] 捕获参数设置生效
- [ ] 配置能够保存和加载
- [ ] 高级选项警告显示

#### 技术验收
- [ ] 与现有系统无冲突
- [ ] 代码风格一致
- [ ] 异常处理完善
- [ ] 单元测试覆盖

#### 用户体验验收
- [ ] 界面直观易用
- [ ] 实时反馈及时
- [ ] 错误提示清晰
- [ ] 操作流程顺畅

### 5. 技术约束

**开发约束**:
- 使用Python 3.x + tkinter
- 基于Scapy进行网络操作
- 遵循现有代码规范
- 保持向后兼容性

**性能约束**:
- 界面响应时间 < 200ms
- 过滤器验证时间 < 100ms
- 接口信息获取时间 < 500ms

**安全约束**:
- 混杂模式需要管理员权限
- 敏感配置加密存储
- 输入参数严格验证

### 6. 集成方案

**文件结构**:
```
src/network_analyzer/gui/
├── dialogs/
│   └── capture_options_dialog.py  # 新增
├── components/
│   ├── filter_templates.py        # 新增
│   └── interface_info.py          # 新增
└── main_window.py                 # 修改
```

**配置扩展**:
```python
# settings.py 新增配置项
CAPTURE_FILTER_TEMPLATES = [...]
CAPTURE_INTERFACE_DETAILS = True
CAPTURE_REALTIME_VALIDATION = True
```

## 确认状态

- [x] 需求边界清晰无歧义
- [x] 技术方案与现有架构对齐  
- [x] 验收标准具体可测试
- [x] 所有关键假设已确认
- [x] 项目特性规范已对齐

**下一步**: 进入架构设计阶段 (Architect)