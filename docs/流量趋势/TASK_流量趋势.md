# 流量趋势功能 - 任务拆分文档

## 文档信息
- **任务名称**: 流量趋势功能
- **阶段**: Atomize (原子化阶段)
- **创建时间**: 2025-01-27
- **基于文档**: DESIGN_流量趋势.md

## 1. 任务依赖关系图

```plantuml
@startuml
!define TASK rectangle

TASK T1 [T1: 数据查询层扩展]
TASK T2 [T2: 数据处理器实现]
TASK T3 [T3: 图表管理器实现]
TASK T4 [T4: 主对话框UI实现]
TASK T5 [T5: 实时更新机制]
TASK T6 [T6: 协议过滤功能]
TASK T7 [T7: PNG导出功能]
TASK T8 [T8: 主窗口集成]
TASK T9 [T9: 单元测试]

T1 --> T2
T2 --> T3
T3 --> T4
T4 --> T5
T4 --> T6
T3 --> T7
T4 --> T8
T8 --> T9

note right of T1 : 基础数据支持
note right of T4 : 核心UI组件
note right of T9 : 质量保证
@enduml
```

## 2. 原子任务详细定义

### T1: 数据查询层扩展
**任务ID**: T1_DataManager_Extension
**优先级**: 高
**预估时间**: 45分钟

#### 输入契约
- **前置依赖**: 现有DataManager类
- **输入数据**: 无
- **环境依赖**: sqlite3, datetime

#### 输出契约
- **交付物**: 扩展后的DataManager类
- **输出数据**: 
  ```python
  def get_traffic_trends_data(start_time, end_time, protocols=None) -> Dict
  def get_protocol_traffic_by_time(protocol, start_time, end_time) -> List
  ```
- **验收标准**: 
  - [ ] 新增方法能正确查询指定时间范围的数据包
  - [ ] 支持协议过滤（TCP/UDP/ICMP/DNS）
  - [ ] 查询性能满足要求（5分钟数据<1秒）
  - [ ] 返回数据格式符合接口定义

#### 实现约束
- **技术栈**: Python, sqlite3
- **接口规范**: 保持现有DataManager接口兼容性
- **质量要求**: 添加错误处理和日志记录

---

### T2: 数据处理器实现
**任务ID**: T2_TrafficDataProcessor
**优先级**: 高
**预估时间**: 30分钟

#### 输入契约
- **前置依赖**: T1完成
- **输入数据**: 原始数据包列表
- **环境依赖**: datetime, collections

#### 输出契约
- **交付物**: TrafficDataProcessor类
- **输出数据**: 
  ```python
  def aggregate_by_seconds(packets) -> Dict
  def calculate_bandwidth(packets) -> Dict
  def group_by_protocol(packets) -> Dict
  ```
- **验收标准**:
  - [ ] 能按秒级聚合数据包统计
  - [ ] 正确计算带宽（字节/秒）
  - [ ] 按协议分组统计准确
  - [ ] 处理空数据集不报错

#### 实现约束
- **技术栈**: Python标准库
- **接口规范**: 纯函数设计，无副作用
- **质量要求**: 高效的数据聚合算法

---

### T3: 图表管理器实现
**任务ID**: T3_ChartManager
**优先级**: 高
**预估时间**: 60分钟

#### 输入契约
- **前置依赖**: T2完成
- **输入数据**: 聚合后的趋势数据
- **环境依赖**: matplotlib, tkinter

#### 输出契约
- **交付物**: ChartManager类
- **输出数据**: matplotlib图表对象
- **验收标准**:
  - [ ] 创建多协议趋势线图表
  - [ ] 支持动态更新图表数据
  - [ ] 实现协议线显示/隐藏切换
  - [ ] 图表样式美观，标签清晰
  - [ ] 支持PNG格式导出

#### 实现约束
- **技术栈**: matplotlib, numpy
- **接口规范**: 与tkinter Canvas集成
- **质量要求**: 图表渲染性能优化

---

### T4: 主对话框UI实现
**任务ID**: T4_TrafficTrendsDialog
**优先级**: 高
**预估时间**: 90分钟

#### 输入契约
- **前置依赖**: T3完成
- **输入数据**: DataManager实例
- **环境依赖**: tkinter, ttk

#### 输出契约
- **交付物**: TrafficTrendsDialog类
- **输出数据**: 独立的趋势显示窗口
- **验收标准**:
  - [ ] 创建独立的对话框窗口
  - [ ] 集成matplotlib图表显示
  - [ ] 添加协议过滤复选框
  - [ ] 添加导出按钮
  - [ ] 添加时间范围选择控件
  - [ ] 窗口可调整大小，布局自适应

#### 实现约束
- **技术栈**: tkinter, ttk
- **接口规范**: 继承tkinter.Toplevel
- **质量要求**: UI响应流畅，布局美观

---

### T5: 实时更新机制
**任务ID**: T5_RealTimeUpdate
**优先级**: 中
**预估时间**: 45分钟

#### 输入契约
- **前置依赖**: T4完成
- **输入数据**: 无
- **环境依赖**: threading, time

#### 输出契约
- **交付物**: 实时更新功能
- **输出数据**: 自动刷新的图表
- **验收标准**:
  - [ ] 每秒自动更新图表数据
  - [ ] 后台线程不阻塞UI
  - [ ] 窗口关闭时正确停止更新
  - [ ] 更新过程中处理异常

#### 实现约束
- **技术栈**: threading.Timer
- **接口规范**: 线程安全的UI更新
- **质量要求**: 内存泄漏防护

---

### T6: 协议过滤功能
**任务ID**: T6_ProtocolFilter
**优先级**: 中
**预估时间**: 30分钟

#### 输入契约
- **前置依赖**: T4完成
- **输入数据**: 协议选择状态
- **环境依赖**: tkinter事件系统

#### 输出契约
- **交付物**: 协议过滤控制
- **输出数据**: 动态显示/隐藏的趋势线
- **验收标准**:
  - [ ] 复选框控制协议线显示
  - [ ] 实时切换不重新查询数据
  - [ ] 支持全选/全不选
  - [ ] 至少保持一个协议可见

#### 实现约束
- **技术栈**: tkinter事件绑定
- **接口规范**: 事件驱动的状态管理
- **质量要求**: 交互响应及时

---

### T7: PNG导出功能
**任务ID**: T7_PNGExport
**优先级**: 中
**预估时间**: 30分钟

#### 输入契约
- **前置依赖**: T3完成
- **输入数据**: 当前图表状态
- **环境依赖**: matplotlib, tkinter.filedialog

#### 输出契约
- **交付物**: PNG导出功能
- **输出数据**: 保存的PNG图片文件
- **验收标准**:
  - [ ] 弹出文件保存对话框
  - [ ] 支持自定义文件名
  - [ ] 导出高质量PNG图片（300 DPI）
  - [ ] 处理文件保存异常

#### 实现约束
- **技术栈**: matplotlib.pyplot.savefig
- **接口规范**: 标准文件对话框
- **质量要求**: 图片质量和文件大小平衡

---

### T8: 主窗口集成
**任务ID**: T8_MainWindowIntegration
**优先级**: 低
**预估时间**: 15分钟

#### 输入契约
- **前置依赖**: T4完成
- **输入数据**: MainWindow实例
- **环境依赖**: 现有主窗口代码

#### 输出契约
- **交付物**: 集成后的主窗口
- **输出数据**: 可用的"流量趋势"菜单项
- **验收标准**:
  - [ ] 替换现有占位符实现
  - [ ] 菜单项点击正确打开对话框
  - [ ] 传递正确的DataManager实例
  - [ ] 不影响其他功能

#### 实现约束
- **技术栈**: 现有代码修改
- **接口规范**: 保持现有接口不变
- **质量要求**: 最小化代码变更

---

### T9: 单元测试
**任务ID**: T9_UnitTests
**优先级**: 中
**预估时间**: 60分钟

#### 输入契约
- **前置依赖**: T1-T8全部完成
- **输入数据**: 实现的所有类和方法
- **环境依赖**: unittest, mock

#### 输出契约
- **交付物**: 完整的测试套件
- **输出数据**: 测试报告
- **验收标准**:
  - [ ] 数据查询方法单元测试
  - [ ] 数据处理器功能测试
  - [ ] 图表管理器测试（mock matplotlib）
  - [ ] UI组件基础测试
  - [ ] 异常处理测试
  - [ ] 测试覆盖率 > 80%

#### 实现约束
- **技术栈**: unittest, unittest.mock
- **接口规范**: 标准测试框架
- **质量要求**: 测试用例全面，断言准确

## 3. 实施计划

### 3.1 开发顺序
1. **第一批** (并行): T1, T2 (数据层基础)
2. **第二批**: T3 (图表层)
3. **第三批**: T4 (UI层)
4. **第四批** (并行): T5, T6, T7 (功能增强)
5. **第五批**: T8 (集成)
6. **第六批**: T9 (测试)

### 3.2 里程碑检查点
- **M1**: 数据查询和处理完成 (T1, T2)
- **M2**: 基础图表显示完成 (T3, T4)
- **M3**: 完整功能实现 (T5, T6, T7)
- **M4**: 集成测试通过 (T8, T9)

### 3.3 风险控制
- **技术风险**: matplotlib版本兼容性 → 提前验证
- **性能风险**: 大数据集查询 → 分页和缓存
- **集成风险**: UI线程安全 → 严格测试

## 4. 质量门控

### 4.1 每个任务完成标准
- [ ] 功能实现完整
- [ ] 代码符合项目规范
- [ ] 基础测试通过
- [ ] 文档更新同步

### 4.2 整体验收标准
- [ ] 所有原子任务完成
- [ ] 集成测试通过
- [ ] 性能指标达标
- [ ] 用户体验良好

## 5. 下一步行动

1. **立即开始**: T1和T2任务（数据层基础）
2. **准备环境**: 确认matplotlib依赖
3. **创建文件**: 按设计文档创建新文件
4. **逐步实施**: 按依赖顺序完成各任务